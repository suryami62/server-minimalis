# ===================================================================================
# Docker Compose Configuration for Nginx Proxy Manager with PostgreSQL Database
# ===================================================================================
#
# Docker Compose file version. '3.8' is a stable and modern version.
version: "3.8"

# Main block where all services (containers) are defined.
services:
  # --- Service 1: Nginx Proxy Manager (Main Application) ---
  app:
    # Use the official Docker image for Nginx Proxy Manager.
    # The ':latest' tag pulls the latest stable version.
    image: "jc21/nginx-proxy-manager:latest"

    # Assign a recognizable name to the container when running.
    container_name: nginx-proxy-manager

    # Restart policy. 'unless-stopped' ensures the container will
    # automatically restart if it crashes or the server reboots,
    # unless it is manually stopped. This is important for availability.
    restart: unless-stopped

    # Map ports from host to container. Format: 'HOST:CONTAINER'.
    ports:
      - "80:80"   # Standard port for HTTP traffic.
      - "443:443" # Standard port for HTTPS (SSL/TLS) traffic.
      - "81:81"   # Port for accessing the Nginx Proxy Manager Web Admin UI.

    # Environment variables injected into the container for configuration.
    environment:
      # Explicitly tell NPM to use the PostgreSQL database driver.
      DB_TYPE: postgres
      # Hostname of the database service. 'db' refers to the database service below.
      # Docker Compose automatically manages internal DNS within the custom network.
      DB_POSTGRES_HOST: "db"
      # Standard port for PostgreSQL.
      DB_POSTGRES_PORT: 5432
      # Credentials for connecting to the database.
      # The ${...} syntax pulls values from the .env file in the same directory.
      # This is best practice to keep credentials secure.
      DB_POSTGRES_USER: ${POSTGRES_USER}
      DB_POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      DB_POSTGRES_NAME: ${POSTGRES_DB}

    # Define volumes to persist data on the host machine.
    volumes:
      # Store all NPM configuration data (proxy hosts, users, access lists).
      - ./data:/data
      # Store SSL/TLS certificates generated by Let's Encrypt.
      # This ensures certificates don’t need to be reissued every container restart.
      - ./letsencrypt:/etc/letsencrypt

    # Define startup order. This container ('app') will wait
    # for the 'db' container to start first. Prevents DB connection errors.
    depends_on:
      - db

    # Connect this container to the defined networks.
    networks:
      # Internal network for communication between NPM and its database.
      - npm-network
      # External network for communication with other applications to be proxied.
      - app-network

  # --- Service 2: PostgreSQL Database ---
  db:
    # Use the official PostgreSQL v18.0 image based on Alpine Linux.
    # The 'alpine' variant is smaller, saving disk space and improving efficiency.
    image: "postgres:18.0-alpine"

    # Assign a recognizable name to the database container.
    container_name: npm-db-postgres

    # Same restart policy to ensure the database is always available to the app.
    restart: unless-stopped

    # Environment variables used by the PostgreSQL image on first run
    # to initialize the database, user, and password.
    # These values MUST MATCH those used by the 'app' service.
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}

    # Map PostgreSQL’s internal data directory to a host directory.
    # This ensures all database data remains safe and persistent.
    volumes:
      - ./data/postgresql:/var/lib/postgresql/18/docker

    # Connect the database container only to the internal network.
    # This is a good security practice; the database doesn’t need to be exposed
    # to other application networks, only to Nginx Proxy Manager.
    networks:
      - npm-network

# Main block where custom networks are defined.
# Using custom networks is best practice for isolation and security.
networks:
  # Backend network for dedicated communication between NPM and its database.
  npm-network:
    driver: bridge

  # Frontend/public network used by NPM to discover
  # and communicate with other services/containers you want to proxy.
  # (Example: blog container, Nextcloud, etc. must also connect to this network).
  app-network:
    driver: bridge
    